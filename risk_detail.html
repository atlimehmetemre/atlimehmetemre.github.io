{% extends "base.html" %}
{% block title %}Risk DetayÄ± Â· {{ r.title }}{% endblock %}
{% block content %}

<div class="grid grid-2">
  <!-- SOL: RÄ°SK KARTI -->
  <div class="card">
    <h2>{{ r.title }}</h2>
    {% if consensus %}
      <div class="flash info">
        ðŸ”” KonsensÃ¼s: P={{ consensus.p }}, Åž={{ consensus.s }} ({{ consensus.count }} oy, eÅŸik {{ threshold }})
      </div>
    {% endif %}

    <form method="post" class="grid grid-2">
      <div>
        <label>BaÅŸlÄ±k</label>
        <input class="input" name="title" value="{{ r.title }}">
      </div>
      <div>
        <label>Kategori</label>
        <input class="input" name="category" value="{{ r.category or '' }}">
      </div>

      <div>
        <label>Durum</label>
        <select class="input" name="status">
          {% for s in ['Open','Assessed','Mitigating','Closed'] %}
            <option value="{{ s }}" {{ 'selected' if r.status==s }}>{{ s }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label>Risk Tipi</label>
        <select class="input" name="risk_type">
          <option value="" {{ 'selected' if not r.risk_type }}>â€”</option>
          <option value="product" {{ 'selected' if r.risk_type=='product' }}>ÃœrÃ¼n</option>
          <option value="project" {{ 'selected' if r.risk_type=='project' }}>Proje</option>
        </select>
      </div>

      <div>
        <label>Sorumlu</label>
        <input class="input" name="responsible" value="{{ r.responsible or '' }}">
      </div>

      <div style="grid-column:1/-1">
        <label>AÃ§Ä±klama</label>
        <textarea class="input" name="description" rows="3">{{ r.description or '' }}</textarea>
      </div>

      <div style="grid-column:1/-1">
        <label>Ã–nlemler (Mitigation)</label>
        <textarea class="input" name="mitigation" rows="3">{{ r.mitigation or '' }}</textarea>
      </div>

      <div style="grid-column:1/-1; display:flex; gap:8px; justify-content:flex-end">
        <button class="btn btn-primary">Kaydet</button>
      </div>
    </form>
  </div>

  <!-- SAÄž: DEÄžERLENDÄ°RMELER -->
  <div class="card">
    <h3>DeÄŸerlendirmeler</h3>

    <!-- RPN Ã–zeti -->
    <div class="grid grid-2" style="margin-bottom:10px">
      <div>
        <div class="small">Ortalama P / S / D</div>
        <strong>
          P={{ '%.1f'|format(r.avg_prob() or 0) }},
          S={{ '%.1f'|format(r.avg_sev() or 0) }},
          D={{ '%.1f'|format(r.avg_det() or 0) if r.avg_det() is not none else 'â€”' }}
        </strong>
      </div>
      <div>
        <div class="small">RPN</div>
        {% set grade, color = r.rpn_grade() %}
        {% if r.rpn() %}
          <span class="badge">{{ '%.2f'|format(r.rpn()) }} Â· {{ grade }}</span>
        {% else %}
          â€”
        {% endif %}
      </div>
    </div>

    <!-- DeÄŸerlendirme Formu -->
    <form method="post" action="{{ url_for('add_eval', risk_id=r.id) }}" class="grid">
      <div class="grid grid-3">
        <div>
          <label>OlasÄ±lÄ±k (P)</label>
          <select class="input" name="probability">
            {% for i in range(1,6) %}<option value="{{ i }}">{{ i }}</option>{% endfor %}
          </select>
        </div>
        <div>
          <label>Åžiddet (S)</label>
          <select class="input" name="severity">
            {% for i in range(1,6) %}<option value="{{ i }}">{{ i }}</option>{% endfor %}
          </select>
        </div>
        <div>
          <label>Tespit (D)</label>
          <select class="input" name="detection">
            <option value="">â€”</option>
            {% for i in range(1,6) %}<option value="{{ i }}">{{ i }}</option>{% endfor %}
          </select>
        </div>
      </div>

      <input class="input" name="evaluator" placeholder="DeÄŸerlendiren (opsiyonel)">
      <input class="input" name="comment" placeholder="Yorum (opsiyonel)">
      <button class="btn btn-success">DeÄŸerlendirmeyi Ekle</button>
    </form>

    <!-- DeÄŸerlendirme Tablosu -->
    <table class="table" style="margin-top:10px">
      <thead>
        <tr>
          <th>Tarih</th><th>DeÄŸerlendiren</th><th>P</th><th>Åž</th><th>D</th><th>RPN</th><th>Yorum</th>
        </tr>
      </thead>
      <tbody>
        {% for e in r.evaluations|sort(attribute='id', reverse=True) %}
          <tr>
            <td>{{ e.created_at.strftime('%Y-%m-%d %H:%M') if e.created_at else '-' }}</td>
            <td>{{ e.evaluator or '-' }}</td>
            <td>{{ e.probability }}</td>
            <td>{{ e.severity }}</td>
            <td>{{ e.detection if e.detection is not none else 'â€”' }}</td>
            <td>{{ e.rpn() if e.rpn() is not none else 'â€”' }}</td>
            <td>{{ e.comment or '-' }}</td>
          </tr>
        {% else %}
          <tr><td colspan="7">HenÃ¼z deÄŸerlendirme yok.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- ALT: YORUMLAR -->
  <div class="card" style="grid-column:1/-1">
    <h3>Yorumlar</h3>
    <div class="grid">
      {% for c in r.comments|sort(attribute='id', reverse=True) %}
        <div class="comment {% if c.is_system %}system{% endif %}">
          <div style="display:flex;justify-content:space-between;gap:8px">
            <strong>{% if c.is_system %}Sistem{% else %}KullanÄ±cÄ±{% endif %}</strong>
            <span class="small">
              {{ c.created_at.strftime('%Y-%m-%d') if c.created_at else '' }}
              Â·
              {{ c.created_at.strftime('%H:%M') if c.created_at else '' }}
            </span>
          </div>
          <div>{{ c.text }}</div>
        </div>
      {% else %}
        <div class="small">Yorum yok.</div>
      {% endfor %}
    </div>

    <form method="post" action="{{ url_for('add_comment', risk_id=r.id) }}" style="margin-top:12px">
      <label>Yeni Yorum</label>
      <textarea class="input" name="text" rows="2" placeholder="GÃ¼ncelleme veya not girin"></textarea>
      <div style="display:flex;justify-content:flex-end;margin-top:8px">
        <button class="btn">Yorum Ekle</button>
      </div>
    </form>
  </div>
</div>

{% if suggestions and suggestions|length %}
  <div class="card" style="margin-top:12px">
    <h3>Ã–neriler ({{ r.category }})</h3>
    <ul>
      {% for s in suggestions %}
        <li>{{ s.text }}</li>
      {% endfor %}
    </ul>
  </div>
{% endif %}

{% endblock %}
